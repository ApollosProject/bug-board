{% extends "base.html" %}

{% block title %}Apollos Bug Board{% endblock %}

{% block extra_head %}
<style>
  #score-tooltip[data-tooltip]::before,
  td.score-breakdown[data-tooltip]::before {
    font-size: 0.7em;
    white-space: pre;
    font-weight: 400;
    width: max-content;
  }
</style>
{% endblock %}

{% block header_nav %}{% endblock %}

{% block content %}
    {#
    <h2>Priority Bug Stats</h2>
    <form method="get" style="display:inline-block; margin-bottom: 0.5em;">
      <select name="days" onchange="this.form.submit()">
        <option value="7"  {{ 'selected' if days == 7 else '' }}>7d</option>
        <option value="30" {{ 'selected' if days == 30 else '' }}>30d</option>
        <option value="90" {{ 'selected' if days == 90 else '' }}>90d</option>
      </select>
    </form>
    <div id="priority-stats" aria-busy="true"></div>
    #}
    <section id="open-items" aria-busy="true"></section>
    <section id="leaderboard" aria-busy="true"></section>
{% endblock %}

{% block extra_scripts %}
<script>
  const days = {{ days }};
  let chartLibraryPromise;

  function ensureChartLibrary() {
    if (!chartLibraryPromise) {
      chartLibraryPromise = new Promise((resolve) => {
        if (window.Chart) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => resolve();
        document.head.appendChild(script);
      });
    }
    return chartLibraryPromise;
  }

  async function loadSection(id, url, onLoad) {
    const container = document.getElementById(id);
    if (!container) {
      return;
    }
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Failed to load ${id}`);
      }
      const html = await response.text();
      container.innerHTML = html;
      container.removeAttribute('aria-busy');
      if (onLoad) {
        onLoad();
      }
    } catch (error) {
      container.innerHTML = '<article>Unable to load section.</article>';
      container.removeAttribute('aria-busy');
    }
  }

  async function renderPlatformChart() {
    const canvas = document.getElementById('platform-chart');
    if (!canvas) {
      return;
    }
    const labels = JSON.parse(canvas.dataset.labels || '[]');
    const values = JSON.parse(canvas.dataset.values || '[]');
    if (!labels.length) {
      return;
    }
    await ensureChartLibrary();
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'New Priority Bugs',
          data: values,
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
            }
          }
        }
      }
    });
  }

  // Priority bug stats section intentionally disabled while we evaluate alternatives.
  // loadSection(
  //   'priority-stats',
  //   `/partials/index/priority-stats?days=${days}`,
  //   renderPlatformChart
  // );
  loadSection('open-items', `/partials/index/open-items?days=${days}`);
  loadSection('leaderboard', `/partials/index/leaderboard?days=${days}`);
</script>
{% endblock %}
