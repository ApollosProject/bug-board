{% extends "base.html" %}

{% block title %}{{ person_name|first_name }}{% endblock %}

{% block extra_head %}
<style>
  #work-done-tooltip[data-tooltip]::before {
    font-size: 0.7em;
  }
  h1.low {
    color: #b33;
  }
  h1.high {
    color: #3b3;
  }
</style>
{% endblock %}

{% block header_nav %}{% endblock %}

{% block content %}
      <div id="person-content" aria-busy="true"></div>
{% endblock %}

{% block extra_scripts %}
<script>
  const days = {{ days }};
  const slug = "{{ person_slug }}";
  let chartLibraryPromise;

  function ensureChartLibrary() {
    if (!chartLibraryPromise) {
      chartLibraryPromise = new Promise((resolve) => {
        if (window.Chart) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => resolve();
        document.head.appendChild(script);
      });
    }
    return chartLibraryPromise;
  }

  async function renderPlatformChart() {
    const canvas = document.getElementById('platformChart');
    if (!canvas) {
      return;
    }
    const labels = JSON.parse(canvas.dataset.labels || '[]');
    const values = JSON.parse(canvas.dataset.values || '[]');
    if (!labels.length) {
      return;
    }
    await ensureChartLibrary();
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '',
          data: values,
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
            }
          }
        }
      }
    });
  }

  async function loadSection(id, url, onLoad) {
    const container = document.getElementById(id);
    if (!container) {
      return;
    }
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Failed to load ${id}`);
      }
      const html = await response.text();
      container.innerHTML = html;
      container.removeAttribute('aria-busy');
      if (onLoad) {
        onLoad();
      }
    } catch (error) {
      container.innerHTML = '<article>Unable to load section.</article>';
      container.removeAttribute('aria-busy');
    }
  }

  loadSection('person-content', `/partials/team/${slug}/content?days=${days}`, renderPlatformChart);
</script>
{% endblock %}
