{% extends "base.html" %}

{% block title %}{{ person_name|first_name }}{% endblock %}

{% block extra_head %}
<style>
  #work-done-tooltip[data-tooltip]::before {
    font-size: 0.7em;
  }
  h1.low {
    color: #b33;
  }
  h1.high {
    color: #3b3;
  }
</style>
{% endblock %}

{% block header_nav %}{% endblock %}

{% block content %}
      <h2>{{ 'Current Support Work' if on_call_support else 'Current Project Work' }}</h2>
      {% if open_current_cycle %}
      {% for project, issues in open_current_cycle.items() %}
      <details open>
        <summary>{{ project }}</summary>
        {% for issue in issues %}
        <div class="card">
          <article>
            <a href="{{ issue.url }}">{{ issue.title }}</a>
            <small style="opacity: 0.6">({{ issue.daysUpdated }}d)</small>
          </article>
        </div>
        {% endfor %}
      </details>
      {% endfor %}
      {% else %}
        <p>(Empty)</p>
      {% endif %}
      {% if open_other %}
      <h2>Other Work</h2>
      {% for project, issues in open_other.items() %}
      <details>
        <summary>{{ project }}</summary>
        {% for issue in issues %}
        <div class="card">
          <article>
            <a href="{{ issue.url }}">{{ issue.title }}</a>
            <small style="opacity: 0.6">({{ issue.daysUpdated }}d)</small>
          </article>
        </div>
        {% endfor %}
      </details>
      {% endfor %}
      {% endif %}
      <hr />
      <form method="get" style="display:inline-block; margin-bottom: 0.5em;">
        <select name="days" onchange="this.form.submit()">
          <option value="1"  {{ 'selected' if days == 1 else '' }}>1d</option>
          <option value="7"  {{ 'selected' if days == 7 else '' }}>7d</option>
          <option value="30" {{ 'selected' if days == 30 else '' }}>30d</option>
        </select>
      </form>
      <div class="grid">
        <div>
          <article>
            <header>
              {% if github_username %}
              <a href="https://github.com/pulls?q=is%3Aclosed+is%3Apr+author%3A{{ github_username | urlencode }}+archived%3Afalse">PRs Merged</a>
              {% else %}
              PRs Merged
              {% endif %}
            </header>
            <h1>{{ prs_merged }}</h1>
          </article>
        </div>
        <div>
          <article>
            <header>PRs Reviewed</header>
            <h1>{{ prs_reviewed }}</h1>
          </article>
        </div>
      </div>
      <div class="grid">
        <div>
          <article>
            <header><a href="https://linear.app/differential/view/sla-issues-7e2098ebf79e">Priority Bugs Fixed</a></header>
            <h1>{{ priority_bugs_fixed }}</h1>
          </article>
        </div>
        <div>
          <article>
            <header>Priority Bug Time to Fix</header>
            {% if priority_bug_avg_time_to_fix is not none %}
            <h1>{{ priority_bug_avg_time_to_fix }}d</h1>
            {% else %}
            <h1>n/a</h1>
            {% endif %}
          </article>
        </div>
      </div>

      <div class="grid">
        <div>
          <article>
            <header>
              <a href="https://linear.app/differential/profiles/{{ linear_username }}">All Work Done</a>
              <small id="work-done-tooltip" data-tooltip="< 2/week: red; ≥ 5/week: green" style="font-size: 0.8em; opacity: 0.6;">ⓘ</small>
            </header>
            {% if days >= 7 %}
              {% set rate = (all_work_done * 7 / days) %}
            {% endif %}
            <h1{% if days >= 7 and rate < 2 %} class="low"{% elif days >= 7 and rate >= 5 %} class="high"{% endif %}>
              {{ all_work_done }}
            </h1>
          </article>
        </div>
        <div>
          <article>
            <header>Time to Completion</header>
            {% if avg_all_time_to_fix is not none %}
            <h1>{{ avg_all_time_to_fix }}d</h1>
            {% else %}
            <h1>n/a</h1>
            {% endif %}
          </article>
        </div>
      </div>
      <div class="grid">
        <div>
          <article>
            <header><a href="https://linear.app/differential/projects/all">Current Projects</a></header>
            <h1>{{ lead_current_projects }}</h1>
          </article>
        </div>
        <div>
          <article>
            <header><a href="https://linear.app/differential/projects/all">Completed Projects</a></header>
            <h1>{{ lead_completed_projects }}</h1>
          </article>
        </div>
        <div>
          <article>
            <header><a href="https://linear.app/differential/projects/all">Incomplete Projects</a></header>
            <h1>{{ lead_incomplete_projects }}</h1>
          </article>
        </div>
      </div>
      {% if work_by_platform %}
      <hr />
      <h2>Work by Platform</h2>
      <article>
        <div>
          <canvas id="platformChart"></canvas>
        </div>
      </article>
      {% endif %}

      {% if completed_by_project %}
        <h2>Completed</h2>
        {% for project, issues in completed_by_project.items() %}
        <details>
          <summary>{{ project }}</summary>
          {% for issue in issues %}
          <div class="card">
            <article>
              <a href="{{ issue.url }}">{{ issue.title }}</a>
              <small style="opacity: 0.6">({{ issue.daysCompleted }}d)</small>
            </article>
          </div>
          {% endfor %}
        </details>
        {% endfor %}
      {% endif %}
{% endblock %}

{% block extra_scripts %}
{% if work_by_platform %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('platformChart');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [
        {% for platform in work_by_platform %}
        '{{ platform }}',
        {% endfor %}
      ],
      datasets: [{
        label: '',
        data: [
          {% for platform in work_by_platform %}
          {{ work_by_platform[platform] | length }},
          {% endfor %}
        ],
        borderWidth: 1
      }]
    },
    options: {
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
          }
        }
      }
    }
  });
</script>
{% endif %}
{% endblock %}
